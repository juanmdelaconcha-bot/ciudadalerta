<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CiudadAlerta ‚Äî Denuncia Ciudadana</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInWithPopup, signInWithEmailAndPassword,
  createUserWithEmailAndPassword, GoogleAuthProvider, signOut }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// ‚îÄ‚îÄ Firebase config ‚îÄ‚îÄ
const firebaseConfig = {
apiKey: ‚ÄúAIzaSyDwRzvyVX55-km767B3SMfb5voCM_wrnJg‚Äù,
authDomain: ‚Äúdenuncia-ciudadana-11d82.firebaseapp.com‚Äù,
projectId: ‚Äúdenuncia-ciudadana-11d82‚Äù,
storageBucket: ‚Äúdenuncia-ciudadana-11d82.firebasestorage.app‚Äù,
messagingSenderId: ‚Äú71646879069‚Äù,
appId: ‚Äú1:71646879069:web:c8b77160978c58ecdb9cb4‚Äù
};

const app      = initializeApp(firebaseConfig);
const db       = getFirestore(app);
const auth     = getAuth(app);
const gProvider = new GoogleAuthProvider();

// ‚îÄ‚îÄ expose to global scope ‚îÄ‚îÄ
window._fb = { db, auth, gProvider,
collection, addDoc, onSnapshot, query, orderBy, serverTimestamp,
onAuthStateChanged, signInWithPopup, signInWithEmailAndPassword,
createUserWithEmailAndPassword, signOut };

window.dispatchEvent(new Event(‚Äòfirebase-ready‚Äô));
</script>

<style>
:root {
  --bg:#080c18; --bg2:#0d1120; --card:#111827; --card2:#162032;
  --border:#1c2d48; --border2:#243650;
  --accent:#ff4d2e; --accent-glow:rgba(255,77,46,.35); --accent2:#ffab36;
  --blue:#4a9eff; --green:#26d87c; --red:#f43f5e; --purple:#a78bfa;
  --text:#e2e8f4; --text2:#94a3bf; --muted:#4d6080;
  --infra:#4a9eff; --env:#26d87c; --sec:#f43f5e; --other:#a78bfa;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;height:58px;background:var(--bg2);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:900}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.3rem;letter-spacing:-.03em;display:flex;align-items:center;gap:.5rem}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.header-center{display:flex;gap:2.5rem}
.hstat{text-align:center}
.hstat-num{font-family:'Syne',sans-serif;font-weight:700;font-size:1.1rem;line-height:1}
.hstat-num.or{color:var(--accent)} .hstat-num.ye{color:var(--accent2)} .hstat-num.gr{color:var(--green)}
.hstat-label{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
.header-right{display:flex;align-items:center;gap:.75rem}
.btn-new{display:flex;align-items:center;gap:.5rem;background:var(--accent);color:white;border:none;padding:.55rem 1.2rem;border-radius:8px;font-family:'Syne',sans-serif;font-weight:700;font-size:.85rem;cursor:pointer;transition:all .2s;letter-spacing:.02em}
.btn-new:hover{background:#ff3318;box-shadow:0 0 20px var(--accent-glow);transform:translateY(-1px)}
.btn-new:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* user chip */
.user-chip{display:flex;align-items:center;gap:.5rem;background:var(--card);border:1px solid var(--border2);border-radius:8px;padding:.4rem .75rem;font-size:.8rem;cursor:default}
.user-avatar{width:24px;height:24px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:white;flex-shrink:0}
.user-name{max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2)}
.btn-signout{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.75rem;padding:.2rem .4rem;border-radius:4px;transition:color .2s}
.btn-signout:hover{color:var(--red)}
.btn-login{background:var(--card);border:1px solid var(--border2);color:var(--text2);padding:.4rem .9rem;border-radius:8px;font-size:.8rem;cursor:pointer;transition:all .2s}
.btn-login:hover{border-color:var(--accent);color:var(--accent)}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 58px)}
.sidebar{background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.filter-row{display:flex;gap:.4rem;flex-wrap:wrap;padding:.75rem 1rem;border-bottom:1px solid var(--border);background:rgba(0,0,0,.2)}
.chip{padding:.28rem .7rem;border-radius:20px;border:1px solid var(--border2);font-size:.72rem;font-weight:500;cursor:pointer;background:transparent;color:var(--muted);transition:all .18s}
.chip:hover{color:var(--text);border-color:rgba(255,255,255,.2)}
.chip.active[data-type="all"]  {border-color:var(--accent);color:var(--accent);background:rgba(255,77,46,.1)}
.chip.active[data-type="infra"]{border-color:var(--infra);color:var(--infra);background:rgba(74,158,255,.1)}
.chip.active[data-type="env"]  {border-color:var(--env);color:var(--env);background:rgba(38,216,124,.1)}
.chip.active[data-type="sec"]  {border-color:var(--sec);color:var(--sec);background:rgba(244,63,94,.1)}
.chip.active[data-type="other"]{border-color:var(--purple);color:var(--purple);background:rgba(167,139,250,.1)}
.list-header{padding:.6rem 1rem .4rem;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);border-bottom:1px solid var(--border)}
.cards-list{flex:1;overflow-y:auto;padding:.75rem;scrollbar-width:thin;scrollbar-color:var(--border2) transparent}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.rcard{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:.9rem 1rem;margin-bottom:.6rem;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.rcard::after{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.rcard[data-type="infra"]::after{background:var(--infra)}
.rcard[data-type="env"]::after{background:var(--env)}
.rcard[data-type="sec"]::after{background:var(--sec)}
.rcard[data-type="other"]::after{background:var(--purple)}
.rcard:hover{border-color:var(--border2);background:var(--card2);transform:translateX(3px)}
.rcard.active{border-color:var(--accent);background:rgba(255,77,46,.05)}
.rcard-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.45rem}
.rcard-badge{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;padding:.18rem .55rem;border-radius:4px}
[data-type="infra"] .rcard-badge{color:var(--infra);background:rgba(74,158,255,.12)}
[data-type="env"]   .rcard-badge{color:var(--env);background:rgba(38,216,124,.12)}
[data-type="sec"]   .rcard-badge{color:var(--sec);background:rgba(244,63,94,.12)}
[data-type="other"] .rcard-badge{color:var(--purple);background:rgba(167,139,250,.12)}
.rcard-status{font-size:.68rem;padding:.18rem .55rem;border-radius:4px}
.s-pending{background:rgba(255,171,54,.12);color:var(--accent2)}
.s-review{background:rgba(74,158,255,.12);color:var(--blue)}
.s-resolved{background:rgba(38,216,124,.12);color:var(--green)}
.rcard-title{font-family:'Syne',sans-serif;font-weight:700;font-size:.9rem;margin-bottom:.3rem;line-height:1.3}
.rcard-desc{font-size:.78rem;color:var(--text2);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:.55rem}
.rcard-photo{width:100%;height:80px;object-fit:cover;border-radius:7px;margin-bottom:.55rem;border:1px solid var(--border)}
.rcard-meta{display:flex;justify-content:space-between;font-size:.68rem;color:var(--muted)}
.rcard-loc{display:flex;align-items:center;gap:.25rem;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
#map{width:100%;height:100%}
.map-wrap{position:relative;flex:1}
.leaflet-container{background:#0d1525 !important}
.leaflet-popup-content-wrapper{background:var(--card) !important;border:1px solid var(--border2) !important;border-radius:12px !important;color:var(--text) !important;box-shadow:0 8px 32px rgba(0,0,0,.6) !important;padding:0 !important}
.leaflet-popup-content{margin:0 !important}
.leaflet-popup-tip{background:var(--card) !important}
.leaflet-popup-close-button{color:var(--muted) !important;top:8px !important;right:10px !important}
.popup-wrap{padding:1rem;min-width:220px}
.popup-img{width:100%;height:130px;object-fit:cover;border-radius:8px 8px 0 0;display:block}
.popup-badge{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.4rem}
.popup-title{font-family:'Syne',sans-serif;font-weight:700;font-size:1rem;margin-bottom:.3rem}
.popup-desc{font-size:.78rem;color:var(--text2);line-height:1.5;margin-bottom:.6rem}
.popup-footer{display:flex;justify-content:space-between;font-size:.7rem;color:var(--muted)}

/* ‚îÄ‚îÄ OVERLAY / MODAL ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2000;backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:1rem}
.overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:18px;width:100%;max-width:500px;max-height:92vh;overflow-y:auto;animation:fadeUp .28s ease;scrollbar-width:thin;scrollbar-color:var(--border2) transparent}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.modal-head{padding:1.2rem 1.5rem .9rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--bg2);z-index:1}
.modal-title{font-family:'Syne',sans-serif;font-weight:700;font-size:1.15rem}
.modal-close{background:none;border:none;color:var(--muted);font-size:1.6rem;cursor:pointer;line-height:1;transition:color .2s}
.modal-close:hover{color:var(--text)}
.modal-body{padding:1.2rem 1.5rem 1.5rem;display:flex;flex-direction:column;gap:1.1rem}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.flabel{font-size:.72rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.35rem;display:block}
.finput,.ftarea{background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:.7rem .95rem;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;width:100%}
.finput:focus,.ftarea:focus{border-color:var(--accent)}
.ftarea{resize:vertical;min-height:85px}
.type-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.tbtn{padding:.7rem;border:1px solid var(--border2);border-radius:10px;background:var(--card);color:var(--muted);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.3rem;font-family:'DM Sans',sans-serif;font-size:.8rem}
.tbtn .ticon{font-size:1.35rem}
.tbtn:hover{border-color:rgba(255,255,255,.2);color:var(--text)}
.tbtn.sel[data-type="infra"]{border-color:var(--infra);color:var(--infra);background:rgba(74,158,255,.1)}
.tbtn.sel[data-type="env"]{border-color:var(--env);color:var(--env);background:rgba(38,216,124,.1)}
.tbtn.sel[data-type="sec"]{border-color:var(--sec);color:var(--sec);background:rgba(244,63,94,.1)}
.tbtn.sel[data-type="other"]{border-color:var(--purple);color:var(--purple);background:rgba(167,139,250,.1)}

/* ‚îÄ‚îÄ SUBCATS ‚îÄ‚îÄ */
.subcat-wrap{display:none;animation:fadeIn .22s ease}
.subcat-wrap.show{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.subcat-label-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.55rem}
.subcat-back{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.78rem;display:flex;align-items:center;gap:.3rem;transition:color .2s;padding:0}
.subcat-back:hover{color:var(--text)}
.subcat-grid{display:flex;flex-direction:column;gap:.35rem}
.sbtn{display:flex;align-items:center;gap:.7rem;padding:.65rem .85rem;border-radius:9px;border:1px solid var(--border2);background:var(--card);color:var(--text2);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.82rem;text-align:left;transition:all .18s;width:100%}
.sbtn-icon{font-size:1.1rem;flex-shrink:0;width:22px;text-align:center}
.sbtn-text{flex:1}
.sbtn-text strong{display:block;color:var(--text);font-size:.83rem;font-weight:500}
.sbtn-text small{font-size:.72rem;color:var(--muted)}
.sbtn:hover{border-color:rgba(255,255,255,.2);background:var(--card2)}
.sbtn.sel{border-color:var(--current-color,var(--accent));background:var(--current-bg,rgba(255,77,46,.08))}
.sbtn.sel .sbtn-text strong{color:var(--current-color,var(--accent))}

/* ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ */
.photo-drop{border:2px dashed var(--border2);border-radius:10px;padding:1.2rem;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.photo-drop:hover,.photo-drop.drag{border-color:var(--accent);background:rgba(255,77,46,.05)}
.photo-drop input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.photo-drop-icon{font-size:1.8rem;margin-bottom:.3rem}
.photo-drop-text{font-size:.82rem;color:var(--muted)}
.photo-drop-text span{color:var(--accent)}
.photo-preview{width:100%;height:140px;object-fit:cover;border-radius:9px;border:1px solid var(--border2);display:none}
.photo-remove{display:none;background:rgba(244,63,94,.15);border:1px solid rgba(244,63,94,.3);color:var(--sec);font-size:.75rem;border-radius:6px;padding:.3rem .7rem;cursor:pointer;margin-top:.4rem}

/* ‚îÄ‚îÄ LOCATION ‚îÄ‚îÄ */
.loc-box{background:var(--card);border:1px solid var(--border2);border-radius:9px;padding:.7rem .95rem;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
.loc-txt{font-size:.82rem;color:var(--muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.loc-txt.set{color:var(--green)}
.loc-actions{display:flex;gap:.4rem;flex-shrink:0}
.lbtn{padding:.35rem .7rem;border:none;border-radius:6px;font-size:.72rem;font-weight:600;cursor:pointer;transition:all .2s}
.lbtn-gps{background:var(--accent);color:white}
.lbtn-gps:hover{background:#ff3318}
.lbtn-map{background:#1a3a6a;color:var(--blue)}
.lbtn-map:hover{background:#234d8c}
#mini-map{width:100%;height:170px;border-radius:9px;display:none;margin-top:.5rem;border:1px solid var(--border2)}

/* ‚îÄ‚îÄ SUBMIT / BUTTONS ‚îÄ‚îÄ */
.btn-submit{background:var(--accent);color:white;border:none;padding:.9rem;border-radius:10px;font-family:'Syne',sans-serif;font-weight:700;font-size:1rem;cursor:pointer;transition:all .2s;width:100%;letter-spacing:.02em;display:flex;align-items:center;justify-content:center;gap:.5rem}
.btn-submit:hover{background:#ff3318;box-shadow:0 4px 24px var(--accent-glow);transform:translateY(-1px)}
.btn-submit:disabled{opacity:.6;cursor:not-allowed;transform:none}
.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .7s linear infinite;display:none}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ */
.auth-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:1rem}
.auth-tab{flex:1;padding:.7rem;background:none;border:none;color:var(--muted);font-family:'Syne',sans-serif;font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.06em;cursor:pointer;transition:all .2s;border-bottom:2px solid transparent;margin-bottom:-1px}
.auth-tab.active{color:var(--text);border-bottom-color:var(--accent)}
.btn-google{display:flex;align-items:center;justify-content:center;gap:.6rem;background:white;color:#333;border:none;padding:.75rem;border-radius:9px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:.9rem;cursor:pointer;transition:all .2s;width:100%;margin-bottom:.75rem}
.btn-google:hover{background:#f5f5f5;box-shadow:0 2px 12px rgba(0,0,0,.2)}
.divider{display:flex;align-items:center;gap:.75rem;margin:.75rem 0;font-size:.75rem;color:var(--muted)}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.auth-error{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.3);border-radius:8px;padding:.6rem .85rem;font-size:.8rem;color:var(--sec);display:none}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.empty{text-align:center;padding:3rem 1rem;color:var(--muted)}
.empty-icon{font-size:2.5rem;margin-bottom:.5rem}
.empty p{font-size:.85rem;line-height:1.6}
.toast{position:fixed;bottom:1.5rem;right:1.5rem;padding:.9rem 1.4rem;border-radius:10px;font-weight:700;font-size:.88rem;z-index:3000;transform:translateY(100px);opacity:0;transition:all .3s;display:flex;align-items:center;gap:.5rem}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--green);color:#050e0a}
.toast.error{background:var(--red);color:white}
.loading-bar{position:fixed;top:0;left:0;height:2px;background:var(--accent);width:0;z-index:9999;transition:width .3s}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
@media(max-width:768px){.app{grid-template-columns:1fr;grid-template-rows:55vh 1fr}.sidebar{order:2}.header-center,.header-right .user-name{display:none}}
</style>

</head>
<body>

<div class="loading-bar" id="loading-bar"></div>

<!-- HEADER -->

<header>
  <div class="logo"><div class="logo-dot"></div>Ciudad<span style="color:var(--accent)">Alerta</span></div>
  <div class="header-center">
    <div class="hstat"><div class="hstat-num or" id="ct-total">‚Äì</div><div class="hstat-label">Total</div></div>
    <div class="hstat"><div class="hstat-num ye" id="ct-pend">‚Äì</div><div class="hstat-label">Pendientes</div></div>
    <div class="hstat"><div class="hstat-num gr" id="ct-res">‚Äì</div><div class="hstat-label">Resueltas</div></div>
  </div>
  <div class="header-right">
    <!-- shown when logged out -->
    <button class="btn-login" id="btn-login-header" onclick="openAuthModal()">Iniciar sesi√≥n</button>
    <!-- shown when logged in -->
    <div class="user-chip" id="user-chip" style="display:none">
      <div class="user-avatar" id="user-avatar">?</div>
      <span class="user-name" id="user-name-label">‚Äì</span>
      <button class="btn-signout" onclick="doSignOut()" title="Cerrar sesi√≥n">‚úï</button>
    </div>
    <button class="btn-new" id="btn-new" onclick="openReportModal()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 1v12M1 7h12" stroke="white" stroke-width="2.2" stroke-linecap="round"/></svg>
      Nueva denuncia
    </button>
  </div>
</header>

<!-- APP -->

<div class="app">
  <div class="sidebar">
    <div class="filter-row">
      <button class="chip active" data-type="all"   onclick="doFilter('all',this)">Todas</button>
      <button class="chip"        data-type="infra"  onclick="doFilter('infra',this)">üîß Infra</button>
      <button class="chip"        data-type="env"    onclick="doFilter('env',this)">üåø Ambiente</button>
      <button class="chip"        data-type="sec"    onclick="doFilter('sec',this)">üö® Seguridad</button>
      <button class="chip"        data-type="other"  onclick="doFilter('other',this)">üìå Otro</button>
    </div>
    <div class="list-header" id="list-lbl">Cargando denuncias‚Ä¶</div>
    <div class="cards-list" id="cards-list">
      <div class="empty"><div class="empty-icon" style="animation:pulse 1.5s infinite">‚è≥</div><p>Conectando con Firebase‚Ä¶</p></div>
    </div>
  </div>
  <div class="map-wrap"><div id="map"></div></div>
</div>

<!-- ‚îÄ‚îÄ REPORT MODAL ‚îÄ‚îÄ -->

<div class="overlay" id="overlay-report">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">üìã Nueva Denuncia</div>
      <button class="modal-close" onclick="closeReportModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div>
        <label class="flabel">Categor√≠a *</label>
        <div class="type-grid" id="type-grid">
          <button class="tbtn" data-type="infra" onclick="selType('infra',this)"><span class="ticon">üîß</span><span>Infraestructura</span></button>
          <button class="tbtn" data-type="env"   onclick="selType('env',this)"><span class="ticon">üåø</span><span>Medio Ambiente</span></button>
          <button class="tbtn" data-type="sec"   onclick="selType('sec',this)"><span class="ticon">üö®</span><span>Seguridad</span></button>
          <button class="tbtn" data-type="other" onclick="selType('other',this)"><span class="ticon">üìå</span><span>Otro</span></button>
        </div>
        <div class="subcat-wrap" id="subcat-wrap">
          <div class="subcat-label-row">
            <button class="subcat-back" onclick="goBackType()">‚Üê Cambiar categor√≠a</button>
            <span id="subcat-heading" style="font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;margin-left:auto"></span>
          </div>
          <div class="subcat-grid" id="subcat-grid"></div>
        </div>
      </div>
      <div>
        <label class="flabel">T√≠tulo *</label>
        <input class="finput" id="f-title" type="text" placeholder="Ej: Bache en Av. Principal" maxlength="80">
      </div>
      <div>
        <label class="flabel">Descripci√≥n</label>
        <textarea class="ftarea" id="f-desc" placeholder="Describe el problema con el mayor detalle posible‚Ä¶"></textarea>
      </div>
      <div>
        <label class="flabel">Foto del problema</label>
        <img class="photo-preview" id="photo-prev" alt="vista previa">
        <button class="photo-remove" id="photo-rm" onclick="removePhoto()">‚úï Quitar foto</button>
        <div class="photo-drop" id="photo-drop">
          <input type="file" accept="image/*" id="photo-input" onchange="handlePhoto(event)">
          <div class="photo-drop-icon">üì∑</div>
          <div class="photo-drop-text">Arrastra una imagen o <span>haz clic para subir</span></div>
          <div style="font-size:.7rem;color:var(--muted);margin-top:.2rem">JPG ¬∑ PNG ¬∑ WEBP ‚Äî m√°x 10 MB</div>
        </div>
      </div>
      <div>
        <label class="flabel">Ubicaci√≥n *</label>
        <div class="loc-box">
          <span class="loc-txt" id="loc-txt">Sin ubicaci√≥n seleccionada</span>
          <div class="loc-actions">
            <button class="lbtn lbtn-gps" onclick="getGPS()">üìç GPS</button>
            <button class="lbtn lbtn-map" onclick="toggleMM()">üó∫ Mapa</button>
          </div>
        </div>
        <div id="mini-map"></div>
      </div>
      <div>
        <label class="flabel">Direcci√≥n / referencia</label>
        <input class="finput" id="f-addr" type="text" placeholder="Ej: Calle Morelos 78, Col. Centro">
      </div>
      <button class="btn-submit" id="btn-submit" onclick="submitReport()">
        <div class="spinner" id="spinner"></div>
        <span id="submit-label">Enviar Denuncia</span>
      </button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ -->

<div class="overlay" id="overlay-auth">
  <div class="modal" style="max-width:400px">
    <div class="modal-head">
      <div class="modal-title">üîê Acceder</div>
      <button class="modal-close" onclick="closeAuthModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-login"    onclick="switchAuthTab('login')">Iniciar sesi√≥n</button>
        <button class="auth-tab"        id="tab-register" onclick="switchAuthTab('register')">Registrarse</button>
      </div>
      <button class="btn-google" onclick="loginGoogle()">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.6 33 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.8 2.9l5.7-5.7C34.1 6.5 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 20-8 20-20 0-1.3-.1-2.7-.4-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 16 19 13 24 13c3 0 5.7 1.1 7.8 2.9l5.7-5.7C34.1 6.5 29.3 4 24 4 16.3 4 9.7 8.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5l-6.2-5.2C29.5 35.5 26.9 36.5 24 36.5c-5.2 0-9.6-3.5-11.2-8.3l-6.5 5C9.5 39.4 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.9 2.4-2.5 4.4-4.5 5.8l6.2 5.2C40.8 35.5 44 30.2 44 24c0-1.3-.1-2.7-.4-4z"/></svg>
        Continuar con Google
      </button>
      <div class="divider">o con email</div>
      <div id="auth-error" class="auth-error"></div>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div>
          <label class="flabel">Correo electr√≥nico</label>
          <input class="finput" id="auth-email" type="email" placeholder="correo@ejemplo.com">
        </div>
        <div>
          <label class="flabel">Contrase√±a</label>
          <input class="finput" id="auth-pass" type="password" placeholder="M√≠nimo 6 caracteres">
        </div>
        <button class="btn-submit" id="btn-auth-submit" onclick="submitAuth()">
          <div class="spinner" id="auth-spinner"></div>
          <span id="auth-label">Iniciar sesi√≥n</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const TYPE_NAMES  = { infra:'Infraestructura', env:'Medio Ambiente', sec:'Seguridad', other:'Otro' };
const TYPE_COLORS = { infra:'#4a9eff', env:'#26d87c', sec:'#f43f5e', other:'#a78bfa' };
const TYPE_ICONS  = { infra:'üîß', env:'üåø', sec:'üö®', other:'üìå' };
const STA_LABEL   = { pending:'Pendiente', review:'En revisi√≥n', resolved:'Resuelto' };
const STA_CLS     = { pending:'s-pending', review:'s-review', resolved:'s-resolved' };

const SUBCATS = {
  sec:[
    {id:'asalto-violencia',   icon:'üî™',label:'Asalto con violencia',       hint:'Robo con amenazas, armas o agresi√≥n f√≠sica'},
    {id:'asalto-sin-violencia',icon:'üëú',label:'Asalto sin violencia',       hint:'Robo sin contacto f√≠sico ni amenaza directa'},
    {id:'robo-autopartes',    icon:'üöó',label:'Robo de autopartes',          hint:'Espejos, rines, catalizadores, accesorios'},
    {id:'robo-vehiculo',      icon:'üîë',label:'Robo de veh√≠culo',            hint:'Autom√≥vil, moto, bicicleta'},
    {id:'robo-casa',          icon:'üè†',label:'Robo a casa habitaci√≥n',      hint:'Entrada forzada, allanamiento'},
    {id:'robo-negocio',       icon:'üè™',label:'Robo a negocio',              hint:'Local comercial, tienda, oficina'},
    {id:'vandalismo',         icon:'üñäÔ∏è',label:'Vandalismo / grafiti',        hint:'Da√±os a propiedad p√∫blica o privada'},
    {id:'acoso',              icon:'‚ö†Ô∏è',label:'Acoso o intimidaci√≥n',        hint:'Hostigamiento, amenazas, seguimiento'},
    {id:'pelea',              icon:'ü•ä',label:'Ri√±a o pelea callejera',      hint:'Altercado f√≠sico en v√≠a p√∫blica'},
    {id:'disparo',            icon:'üí•',label:'Detonaciones / disparos',     hint:'Sonidos de arma de fuego en la zona'},
    {id:'fraude',             icon:'üí≥',label:'Fraude o estafa',             hint:'Clonaci√≥n, timo, enga√±o econ√≥mico'},
    {id:'otro-sec',           icon:'üöî',label:'Otro delito',                 hint:'Incidente no listado arriba'},
  ],
  infra:[
    {id:'bache',        icon:'üï≥Ô∏è',label:'Bache / hundimiento',              hint:'Da√±o en pavimento o asfalto'},
    {id:'semaforo',     icon:'üö¶',label:'Sem√°foro da√±ado o apagado',        hint:'Sin funcionar o mal sincronizado'},
    {id:'alumbrado',    icon:'üí°',label:'Falla de alumbrado p√∫blico',       hint:'Postes apagados o parpadeantes'},
    {id:'banqueta',     icon:'üö∂',label:'Banqueta rota o bloqueada',        hint:'Acera en mal estado o con obst√°culos'},
    {id:'fuga-agua',    icon:'üíß',label:'Fuga de agua potable',             hint:'Tuber√≠a rota, desperdicio de agua'},
    {id:'drenaje',      icon:'üåä',label:'Drenaje tapado / inundaci√≥n',      hint:'Coladera bloqueada, encharcamiento'},
    {id:'cables',       icon:'‚ö°',label:'Cables ca√≠dos o peligrosos',      hint:'Riesgo el√©ctrico en v√≠a p√∫blica'},
    {id:'puente',       icon:'üåâ',label:'Da√±o en puente o paso a desnivel', hint:'Estructura con grietas o peligrosa'},
    {id:'se√±alamiento', icon:'üõë',label:'Se√±alamiento vial da√±ado',         hint:'Se√±ales ca√≠das, ilegibles o faltantes'},
    {id:'otro-infra',   icon:'üîß',label:'Otro problema de infraestructura', hint:'No listado arriba'},
  ],
  env:[
    {id:'basura-calle',       icon:'üóëÔ∏è',label:'Basura en v√≠a p√∫blica',      hint:'Acumulaci√≥n en calles o banquetas'},
    {id:'tiradero',           icon:'üèîÔ∏è',label:'Tiradero clandestino',        hint:'Desecho ilegal de escombros o basura'},
    {id:'quema',              icon:'üî•',label:'Quema de basura / residuos', hint:'Incendio intencional de desechos'},
    {id:'fuga-residual',      icon:'‚ò£Ô∏è',label:'Fuga de aguas residuales',   hint:'Derrames de drenaje o aguas negras'},
    {id:'contaminacion-agua', icon:'üåä',label:'Contaminaci√≥n de agua',      hint:'R√≠o, lago, canal contaminado'},
    {id:'ruido',              icon:'üîä',label:'Contaminaci√≥n por ruido',    hint:'Ruido excesivo, m√∫sica, industria'},
    {id:'fauna',              icon:'üêÄ',label:'Fauna nociva / plaga',       hint:'Ratas, cucarachas, perros agresivos'},
    {id:'arbol',              icon:'üå≥',label:'√Årbol ca√≠do o peligroso',    hint:'Riesgo de ca√≠da sobre personas o veh√≠culos'},
    {id:'otro-env',           icon:'üåø',label:'Otro problema ambiental',    hint:'No listado arriba'},
  ],
  other:[
    {id:'obra-ilegal',        icon:'üèóÔ∏è',label:'Obra o construcci√≥n ilegal',    hint:'Sin permiso o que invade espacio p√∫blico'},
    {id:'vendedor-ambulante', icon:'üõí',label:'Vendedor ambulante conflictivo', hint:'Que obstaculiza o genera problemas'},
    {id:'estacionamiento',    icon:'üÖøÔ∏è',label:'Veh√≠culo mal estacionado',      hint:'Bloquea salidas, rampas o accesos'},
    {id:'publicidad',         icon:'üì¢',label:'Publicidad ilegal / propaganda', hint:'Anuncios sin permiso en v√≠a p√∫blica'},
    {id:'mascota',            icon:'üêï',label:'Animal abandonado o maltratado', hint:'Mascota en situaci√≥n de riesgo'},
    {id:'otro-otro',          icon:'üìå',label:'Otro',                           hint:'Situaci√≥n no clasificada'},
  ],
};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let reports = [];
let map, miniMap, miniReady=false, miniMarker=null;
let curFilter='all';
let fType=null, fSubcat=null, fLat=null, fLng=null, fPhoto=null;
let mkrs={};
let currentUser=null;
let authMode='login';
let fbReady=false;

// ‚îÄ‚îÄ WAIT FOR FIREBASE ‚îÄ‚îÄ
window.addEventListener('firebase-ready', initApp);

function initApp() {
  fbReady = true;
  const { auth, onAuthStateChanged, db, collection, query, orderBy, onSnapshot } = window._fb;

  // Auth state
  onAuthStateChanged(auth, user => {
    currentUser = user;
    updateAuthUI(user);
  });

  // Init map
  map = L.map('map').setView([19.432,-99.136],13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    {attribution:'¬© OpenStreetMap ¬© CARTO',maxZoom:19}).addTo(map);

  // Live listener ‚Äî Firestore real-time
  setLoading(true);
  const q = query(collection(db,'denuncias'), orderBy('createdAt','desc'));
  onSnapshot(q, snap => {
    reports = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
    renderAll();
    setLoading(false);
  }, err => {
    console.error(err);
    showToast('Error al cargar denuncias: '+err.message, 'error');
    setLoading(false);
  });
}

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ
function mkIcon(type) {
  const c=TYPE_COLORS[type], i=TYPE_ICONS[type];
  return L.divIcon({className:'',
    html:`<div style="width:34px;height:34px;background:${c};border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:2.5px solid rgba(255,255,255,.75);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(0,0,0,.55)"><span style="transform:rotate(45deg);font-size:14px">${i}</span></div>`,
    iconSize:[34,34],iconAnchor:[17,34],popupAnchor:[0,-38]});
}

function addMarker(r) {
  const m = L.marker([r.lat,r.lng],{icon:mkIcon(r.type)}).addTo(map);
  const c = TYPE_COLORS[r.type];
  const ph = r.photoUrl ? `<img src="${r.photoUrl}" class="popup-img">` : '';
  const subcatLine = r.subcatLabel ? `<div style="font-size:.72rem;color:${c};margin-bottom:.35rem;font-weight:600">${r.subcatIcon||''} ${r.subcatLabel}</div>` : '';
  const uid = r.firestoreId||r.id;
  m.bindPopup(`<div>${ph}<div class="popup-wrap"><div class="popup-badge" style="color:${c}">${TYPE_NAMES[r.type]}</div>${subcatLine}<div class="popup-title">${r.title}</div><div class="popup-desc">${r.desc}</div><div class="popup-footer"><span>üìç ${r.address}</span><span>üëç ${r.votes||0}</span><span>${r.date}</span></div></div></div>`);
  m.on('click',()=>hlCard(uid));
  mkrs[uid]=m;
}

function renderAll() {
  renderCards(); renderMkrs(); updateStats();
}

function renderCards() {
  const el = document.getElementById('cards-list');
  const list = curFilter==='all' ? reports : reports.filter(r=>r.type===curFilter);
  document.getElementById('list-lbl').textContent =
    `${list.length} denuncia${list.length!==1?'s':''} ${curFilter!=='all'?'‚Äî '+TYPE_NAMES[curFilter]:'en tiempo real'}`;
  if(!list.length){
    el.innerHTML=`<div class="empty"><div class="empty-icon">üîç</div><p>No hay denuncias en esta categor√≠a todav√≠a.<br>¬°S√© el primero en reportar!</p></div>`;
    return;
  }
  el.innerHTML=list.map(r=>{
    const uid=r.firestoreId||r.id;
    return `<div class="rcard" id="card-${uid}" data-type="${r.type}" onclick="focusRep('${uid}')">
      <div class="rcard-top"><span class="rcard-badge">${r.subcatIcon||TYPE_ICONS[r.type]} ${r.subcatLabel||TYPE_NAMES[r.type]}</span><span class="rcard-status ${STA_CLS[r.status]||'s-pending'}">${STA_LABEL[r.status]||'Pendiente'}</span></div>
      ${r.photoUrl?`<img class="rcard-photo" src="${r.photoUrl}" alt="">`:''}
      <div class="rcard-title">${r.title}</div>
      <div class="rcard-desc">${r.desc}</div>
      <div class="rcard-meta"><span class="rcard-loc">üìç ${r.address}</span><span>üìÖ ${r.date}</span></div>
    </div>`;
  }).join('');
}

function renderMkrs() {
  Object.values(mkrs).forEach(m=>map&&map.removeLayer(m)); mkrs={};
  (curFilter==='all'?reports:reports.filter(r=>r.type===curFilter)).forEach(addMarker);
}

function updateStats() {
  document.getElementById('ct-total').textContent=reports.length;
  document.getElementById('ct-pend').textContent=reports.filter(r=>r.status==='pending'||!r.status).length;
  document.getElementById('ct-res').textContent=reports.filter(r=>r.status==='resolved').length;
}

function hlCard(uid) {
  document.querySelectorAll('.rcard').forEach(c=>c.classList.remove('active'));
  const c=document.getElementById('card-'+uid);
  if(c){c.classList.add('active');c.scrollIntoView({behavior:'smooth',block:'nearest'});}
}

function focusRep(uid) {
  const r=reports.find(x=>(x.firestoreId||x.id)==uid); if(!r) return;
  map.flyTo([r.lat,r.lng],16,{duration:.7});
  setTimeout(()=>mkrs[uid]?.openPopup(),750);
  hlCard(uid);
}

function doFilter(type,btn) {
  curFilter=type;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  renderAll();
}

// ‚îÄ‚îÄ AUTH UI ‚îÄ‚îÄ
function updateAuthUI(user) {
  const chip=document.getElementById('user-chip');
  const btnLogin=document.getElementById('btn-login-header');
  const btnNew=document.getElementById('btn-new');
  if(user){
    chip.style.display='flex';
    btnLogin.style.display='none';
    document.getElementById('user-avatar').textContent=(user.displayName||user.email||'U')[0].toUpperCase();
    document.getElementById('user-name-label').textContent=user.displayName||user.email;
    btnNew.disabled=false;
    btnNew.title='';
  } else {
    chip.style.display='none';
    btnLogin.style.display='block';
    btnNew.disabled=false; // allow anonymous? set true to require login
    btnNew.title='';
  }
}

// ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ
function openAuthModal() { document.getElementById('overlay-auth').classList.add('open'); }
function closeAuthModal() { document.getElementById('overlay-auth').classList.remove('open'); document.getElementById('auth-error').style.display='none'; }

function switchAuthTab(tab) {
  authMode=tab;
  document.getElementById('tab-login').classList.toggle('active',tab==='login');
  document.getElementById('tab-register').classList.toggle('active',tab==='register');
  document.getElementById('auth-label').textContent=tab==='login'?'Iniciar sesi√≥n':'Crear cuenta';
  document.getElementById('auth-error').style.display='none';
}

function loginGoogle() {
  const {auth,signInWithPopup,gProvider}=window._fb;
  signInWithPopup(auth,gProvider)
    .then(()=>{ closeAuthModal(); showToast('¬°Bienvenido/a! üëã','success'); })
    .catch(e=>showAuthError(e.message));
}

function submitAuth() {
  const {auth,signInWithEmailAndPassword,createUserWithEmailAndPassword}=window._fb;
  const email=document.getElementById('auth-email').value.trim();
  const pass=document.getElementById('auth-pass').value;
  if(!email||!pass){showAuthError('Completa todos los campos.');return;}
  const sp=document.getElementById('auth-spinner');
  const lb=document.getElementById('auth-label');
  sp.style.display='block'; lb.textContent='';
  const fn=authMode==='login'?signInWithEmailAndPassword:createUserWithEmailAndPassword;
  fn(auth,email,pass)
    .then(()=>{ closeAuthModal(); showToast(authMode==='login'?'¬°Bienvenido/a! üëã':'¬°Cuenta creada! üéâ','success'); })
    .catch(e=>{ showAuthError(friendlyAuthError(e.code)); })
    .finally(()=>{ sp.style.display='none'; lb.textContent=authMode==='login'?'Iniciar sesi√≥n':'Crear cuenta'; });
}

function doSignOut() {
  window._fb.signOut(window._fb.auth).then(()=>showToast('Sesi√≥n cerrada','success'));
}

function showAuthError(msg) {
  const el=document.getElementById('auth-error');
  el.textContent=msg; el.style.display='block';
}

function friendlyAuthError(code) {
  const map={'auth/user-not-found':'Correo no registrado.','auth/wrong-password':'Contrase√±a incorrecta.','auth/email-already-in-use':'Este correo ya est√° registrado.','auth/weak-password':'La contrase√±a debe tener al menos 6 caracteres.','auth/invalid-email':'Correo inv√°lido.'};
  return map[code]||'Error de autenticaci√≥n. Intenta de nuevo.';
}

// ‚îÄ‚îÄ REPORT MODAL ‚îÄ‚îÄ
function openReportModal() {
  document.getElementById('overlay-report').classList.add('open');
  fType=null; fSubcat=null; fLat=null; fLng=null; fPhoto=null;
  ['f-title','f-desc','f-addr'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('photo-input').value='';
  document.getElementById('photo-prev').style.display='none';
  document.getElementById('photo-rm').style.display='none';
  document.getElementById('photo-drop').style.display='block';
  document.getElementById('loc-txt').textContent='Sin ubicaci√≥n seleccionada';
  document.getElementById('loc-txt').classList.remove('set');
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('sel'));
  document.getElementById('type-grid').style.display='grid';
  document.getElementById('subcat-wrap').classList.remove('show');
  document.getElementById('f-title').placeholder='Ej: Bache en Av. Principal';
  document.getElementById('mini-map').style.display='none';
  document.getElementById('submit-label').textContent='Enviar Denuncia';
  document.getElementById('spinner').style.display='none';
}
function closeReportModal() { document.getElementById('overlay-report').classList.remove('open'); }

// ‚îÄ‚îÄ TYPE + SUBCAT ‚îÄ‚îÄ
function selType(type,btn) {
  fType=type; fSubcat=null;
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  showSubcats(type);
}

function showSubcats(type) {
  const c=TYPE_COLORS[type];
  const bg=type==='infra'?'rgba(74,158,255,.08)':type==='env'?'rgba(38,216,124,.08)':type==='sec'?'rgba(244,63,94,.08)':'rgba(167,139,250,.08)';
  document.getElementById('subcat-heading').textContent=TYPE_ICONS[type]+' '+TYPE_NAMES[type];
  document.getElementById('subcat-heading').style.color=c;
  document.getElementById('subcat-grid').innerHTML=(SUBCATS[type]||[]).map(s=>`
    <button class="sbtn" style="--current-color:${c};--current-bg:${bg}" onclick="selSubcat('${s.id}',this,'${type}')">
      <span class="sbtn-icon">${s.icon}</span>
      <span class="sbtn-text"><strong>${s.label}</strong><small>${s.hint}</small></span>
    </button>`).join('');
  document.getElementById('type-grid').style.display='none';
  document.getElementById('subcat-wrap').classList.add('show');
}

function selSubcat(id,btn,type) {
  fSubcat=id;
  document.querySelectorAll('.sbtn').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  const sub=(SUBCATS[type]||[]).find(s=>s.id===id);
  if(sub && !document.getElementById('f-title').value.trim())
    document.getElementById('f-title').value=sub.label;
}

function goBackType() {
  fType=null; fSubcat=null;
  document.getElementById('type-grid').style.display='grid';
  document.getElementById('subcat-wrap').classList.remove('show');
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('sel'));
  document.getElementById('f-title').value='';
  document.getElementById('f-title').placeholder='Ej: Bache en Av. Principal';
}

// ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ
function handlePhoto(e) {
  const f=e.target.files[0]; if(!f) return;
  if(f.size>10*1024*1024){showToast('Imagen muy grande (m√°x 10 MB)','error');return;}
  const rd=new FileReader();
  rd.onload=ev=>{
    fPhoto=ev.target.result;
    const p=document.getElementById('photo-prev');
    p.src=fPhoto; p.style.display='block';
    document.getElementById('photo-rm').style.display='inline-block';
    document.getElementById('photo-drop').style.display='none';
  };
  rd.readAsDataURL(f);
}
function removePhoto() {
  fPhoto=null;
  document.getElementById('photo-prev').style.display='none';
  document.getElementById('photo-rm').style.display='none';
  document.getElementById('photo-drop').style.display='block';
  document.getElementById('photo-input').value='';
}
const dropEl=document.getElementById('photo-drop');
dropEl.addEventListener('dragover',e=>{e.preventDefault();dropEl.classList.add('drag');});
dropEl.addEventListener('dragleave',()=>dropEl.classList.remove('drag'));
dropEl.addEventListener('drop',e=>{
  e.preventDefault(); dropEl.classList.remove('drag');
  const f=e.dataTransfer.files[0];
  if(f&&f.type.startsWith('image/')){
    const rd=new FileReader();
    rd.onload=ev=>{
      fPhoto=ev.target.result;
      document.getElementById('photo-prev').src=fPhoto;
      document.getElementById('photo-prev').style.display='block';
      document.getElementById('photo-rm').style.display='inline-block';
      dropEl.style.display='none';
    };
    rd.readAsDataURL(f);
  }
});

// ‚îÄ‚îÄ LOCATION ‚îÄ‚îÄ
function setLoc(lat,lng) {
  fLat=lat; fLng=lng;
  document.getElementById('loc-txt').textContent=`üìç ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  document.getElementById('loc-txt').classList.add('set');
  if(miniReady){ miniMap.setView([lat,lng],15); if(miniMarker) miniMap.removeLayer(miniMarker); miniMarker=L.marker([lat,lng]).addTo(miniMap); }
}
function getGPS() {
  if(!navigator.geolocation){showToast('Tu navegador no soporta GPS','error');return;}
  navigator.geolocation.getCurrentPosition(p=>setLoc(p.coords.latitude,p.coords.longitude),()=>{const c=map.getCenter();setLoc(c.lat,c.lng);});
}
function toggleMM() {
  const mm=document.getElementById('mini-map');
  if(!mm.style.display||mm.style.display==='none'){ mm.style.display='block'; if(!miniReady) initMM(); else setTimeout(()=>miniMap.invalidateSize(),80); }
  else mm.style.display='none';
}
function initMM() {
  miniMap=L.map('mini-map').setView([fLat||19.4326,fLng||-99.1332],14);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(miniMap);
  miniMap.on('click',e=>{ setLoc(e.latlng.lat,e.latlng.lng); if(miniMarker) miniMap.removeLayer(miniMarker); miniMarker=L.marker([e.latlng.lat,e.latlng.lng]).addTo(miniMap); });
  miniReady=true;
  setTimeout(()=>miniMap.invalidateSize(),100);
  if(fLat){ miniMap.setView([fLat,fLng],15); miniMarker=L.marker([fLat,fLng]).addTo(miniMap); }
}

// ‚îÄ‚îÄ SUBMIT TO FIREBASE ‚îÄ‚îÄ
// ‚îÄ‚îÄ COMPRESS IMAGE (canvas resize ‚Äî no Storage needed) ‚îÄ‚îÄ
function compressImage(dataUrl, maxPx, quality) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      let w=img.width, h=img.height;
      if(w>maxPx||h>maxPx){ const r=Math.min(maxPx/w,maxPx/h); w=Math.round(w*r); h=Math.round(h*r); }
      const canvas=document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.src=dataUrl;
  });
}

async function submitReport() {
  if(!fbReady){showToast('Firebase no est√° listo','error');return;}
  const title=document.getElementById('f-title').value.trim();
  if(!fType){showToast('Selecciona una categor√≠a','error');return;}
  if(!fSubcat){showToast('Elige el tipo espec√≠fico de incidente','error');return;}
  if(!title){showToast('Escribe un t√≠tulo','error');return;}
  if(!fLat){showToast('Selecciona una ubicaci√≥n','error');return;}

  const sub=(SUBCATS[fType]||[]).find(s=>s.id===fSubcat);
  const btn=document.getElementById('btn-submit');
  const sp=document.getElementById('spinner');
  const lbl=document.getElementById('submit-label');
  btn.disabled=true; sp.style.display='block'; lbl.textContent='Guardando‚Ä¶';

  try {
    const {db, collection, addDoc, serverTimestamp} = window._fb;

    // 1. Compress photo to max 800px / 60% quality before storing in Firestore
    let photoUrl = null;
    if(fPhoto) {
      photoUrl = await compressImage(fPhoto, 800, 0.6);
    }

    // 2. Save to Firestore (photo stored as compressed base64 string)
    const docData = {
      type: fType,
      subcat: fSubcat,
      subcatLabel: sub?.label||'',
      subcatIcon: sub?.icon||'',
      title,
      desc: document.getElementById('f-desc').value.trim()||'Sin descripci√≥n adicional.',
      address: document.getElementById('f-addr').value.trim()||`${fLat.toFixed(4)}, ${fLng.toFixed(4)}`,
      lat: fLat,
      lng: fLng,
      status: 'pending',
      date: new Date().toISOString().slice(0,10),
      votes: 0,
      photoUrl,
      userId: currentUser?.uid||'anonymous',
      userEmail: currentUser?.email||'an√≥nimo',
      createdAt: serverTimestamp()
    };

    await addDoc(collection(db,'denuncias'), docData);

    closeReportModal();
    map.flyTo([fLat,fLng],16,{duration:.8});
    showToast('‚úÖ Denuncia guardada en Firebase','success');
    miniReady=false; miniMarker=null;

  } catch(err) {
    console.error(err);
    showToast('Error al guardar: '+err.message,'error');
  } finally {
    btn.disabled=false; sp.style.display='none'; lbl.textContent='Enviar Denuncia';
  }
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function showToast(msg, type='success') {
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast '+type;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3500);
}

function setLoading(on) {
  const lb=document.getElementById('loading-bar');
  lb.style.width=on?'70%':'100%';
  if(!on) setTimeout(()=>lb.style.width='0',400);
}

// ‚îÄ‚îÄ CLOSE ON BACKDROP ‚îÄ‚îÄ
document.getElementById('overlay-report').addEventListener('click',e=>{if(e.target===document.getElementById('overlay-report'))closeReportModal();});
document.getElementById('overlay-auth').addEventListener('click',e=>{if(e.target===document.getElementById('overlay-auth'))closeAuthModal();});
document.addEventListener('keydown',e=>{ if(e.key==='Escape'){closeReportModal();closeAuthModal();} });
</script>

</body>
</html>
