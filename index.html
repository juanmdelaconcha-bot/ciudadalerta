<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CiudadAlerta â€” Denuncia Ciudadana</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Firebase compat SDK (no ES modules needed) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDwRzvyVX55-km767B3SMfb5voCM_wrnJg",
  authDomain: "denuncia-ciudadana-11d82.firebaseapp.com",
  projectId: "denuncia-ciudadana-11d82",
  storageBucket: "denuncia-ciudadana-11d82.firebasestorage.app",
  messagingSenderId: "71646879069",
  appId: "1:71646879069:web:c8b77160978c58ecdb9cb4"
};
firebase.initializeApp(firebaseConfig);
window._db   = firebase.firestore();
window._auth = firebase.auth();
window._fbReady = true;
</script>
<style>
:root {
  --bg:#080c18; --bg2:#0d1120; --card:#111827; --card2:#162032;
  --border:#1c2d48; --border2:#243650;
  --accent:#ff4d2e; --accent-glow:rgba(255,77,46,.35); --accent2:#ffab36;
  --blue:#4a9eff; --green:#26d87c; --red:#f43f5e; --purple:#a78bfa;
  --text:#e2e8f4; --text2:#94a3bf; --muted:#4d6080;
  --infra:#4a9eff; --env:#26d87c; --sec:#f43f5e; --other:#a78bfa;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden}

/* â”€â”€ HEADER â”€â”€ */
header{display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;height:58px;background:var(â€“bg2);border-bottom:1px solid var(â€“border);position:sticky;top:0;z-index:900}
.logo{font-family:â€˜Syneâ€™,sans-serif;font-weight:800;font-size:1.3rem;letter-spacing:-.03em;display:flex;align-items:center;gap:.5rem}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(â€“accent);box-shadow:0 0 10px var(â€“accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.header-center{display:flex;gap:2.5rem}
.hstat{text-align:center}
.hstat-num{font-family:â€˜Syneâ€™,sans-serif;font-weight:700;font-size:1.1rem;line-height:1}
.hstat-num.or{color:var(â€“accent)} .hstat-num.ye{color:var(â€“accent2)} .hstat-num.gr{color:var(â€“green)}
.hstat-label{font-size:.65rem;color:var(â€“muted);text-transform:uppercase;letter-spacing:.08em}
.header-right{display:flex;align-items:center;gap:.75rem}
.btn-new{display:flex;align-items:center;gap:.5rem;background:#2a3347;color:var(â€“text);border:1px solid #3a4a65;padding:.55rem 1.2rem;border-radius:8px;font-family:â€˜Syneâ€™,sans-serif;font-weight:700;font-size:.85rem;cursor:pointer;transition:all .2s;letter-spacing:.02em;box-shadow:0 4px 12px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.08)}
.btn-new:hover{background:#344060;border-color:#4a5e80;box-shadow:0 6px 18px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.12);transform:translateY(-2px);color:white}
.btn-new:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* user chip */
.user-chip{display:flex;align-items:center;gap:.5rem;background:var(â€“card);border:1px solid var(â€“border2);border-radius:8px;padding:.4rem .75rem;font-size:.8rem;cursor:default}
.user-avatar{width:24px;height:24px;border-radius:50%;background:var(â€“accent);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:white;flex-shrink:0}
.user-name{max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(â€“text2)}
.btn-signout{background:none;border:none;color:var(â€“muted);cursor:pointer;font-size:.75rem;padding:.2rem .4rem;border-radius:4px;transition:color .2s}
.btn-signout:hover{color:var(â€“red)}
.btn-login{background:var(â€“card);border:1px solid var(â€“border2);color:var(â€“text2);padding:.4rem .9rem;border-radius:8px;font-size:.8rem;cursor:pointer;transition:all .2s}
.btn-login:hover{border-color:var(â€“accent);color:var(â€“accent)}

/* â”€â”€ LAYOUT â”€â”€ */
.app{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 58px)}
.sidebar{background:var(â€“bg2);border-right:1px solid var(â€“border);display:flex;flex-direction:column;overflow:hidden}
.filter-row{display:flex;gap:.4rem;flex-wrap:wrap;padding:.75rem 1rem;border-bottom:1px solid var(â€“border);background:rgba(0,0,0,.2)}
.chip{padding:.28rem .7rem;border-radius:20px;border:1px solid var(â€“border2);font-size:.72rem;font-weight:500;cursor:pointer;background:transparent;color:var(â€“muted);transition:all .18s}
.chip:hover{color:var(â€“text);border-color:rgba(255,255,255,.2)}
.chip.active[data-type=â€œallâ€]  {border-color:var(â€“accent);color:var(â€“accent);background:rgba(255,77,46,.1)}
.chip.active[data-type=â€œinfraâ€]{border-color:var(â€“infra);color:var(â€“infra);background:rgba(74,158,255,.1)}
.chip.active[data-type=â€œenvâ€]  {border-color:var(â€“env);color:var(â€“env);background:rgba(38,216,124,.1)}
.chip.active[data-type=â€œsecâ€]  {border-color:var(â€“sec);color:var(â€“sec);background:rgba(244,63,94,.1)}
.chip.active[data-type=â€œotherâ€]{border-color:var(â€“purple);color:var(â€“purple);background:rgba(167,139,250,.1)}
.list-header{padding:.6rem 1rem .4rem;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(â€“muted);border-bottom:1px solid var(â€“border)}
.cards-list{flex:1;overflow-y:auto;padding:.75rem;scrollbar-width:thin;scrollbar-color:var(â€“border2) transparent}

/* â”€â”€ CARDS â”€â”€ */
.rcard{background:var(â€“card);border:1px solid var(â€“border);border-radius:12px;padding:.9rem 1rem;margin-bottom:.6rem;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.rcard::after{content:â€™â€™;position:absolute;left:0;top:0;bottom:0;width:3px}
.rcard[data-type=â€œinfraâ€]::after{background:var(â€“infra)}
.rcard[data-type=â€œenvâ€]::after{background:var(â€“env)}
.rcard[data-type=â€œsecâ€]::after{background:var(â€“sec)}
.rcard[data-type=â€œotherâ€]::after{background:var(â€“purple)}
.rcard:hover{border-color:var(â€“border2);background:var(â€“card2);transform:translateX(3px)}
.rcard.active{border-color:var(â€“accent);background:rgba(255,77,46,.05)}
.rcard-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.45rem}
.rcard-badge{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;padding:.18rem .55rem;border-radius:4px}
[data-type=â€œinfraâ€] .rcard-badge{color:var(â€“infra);background:rgba(74,158,255,.12)}
[data-type=â€œenvâ€]   .rcard-badge{color:var(â€“env);background:rgba(38,216,124,.12)}
[data-type=â€œsecâ€]   .rcard-badge{color:var(â€“sec);background:rgba(244,63,94,.12)}
[data-type=â€œotherâ€] .rcard-badge{color:var(â€“purple);background:rgba(167,139,250,.12)}
.rcard-status{font-size:.68rem;padding:.18rem .55rem;border-radius:4px}
.s-pending{background:rgba(255,171,54,.12);color:var(â€“accent2)}
.s-review{background:rgba(74,158,255,.12);color:var(â€“blue)}
.s-resolved{background:rgba(38,216,124,.12);color:var(â€“green)}
.rcard-title{font-family:â€˜Syneâ€™,sans-serif;font-weight:700;font-size:.9rem;margin-bottom:.3rem;line-height:1.3}
.rcard-desc{font-size:.78rem;color:var(â€“text2);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:.55rem}
.rcard-photo{width:100%;height:80px;object-fit:cover;border-radius:7px;margin-bottom:.55rem;border:1px solid var(â€“border)}
.rcard-meta{display:flex;justify-content:space-between;font-size:.68rem;color:var(â€“muted)}
.rcard-loc{display:flex;align-items:center;gap:.25rem;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* â”€â”€ MAP â”€â”€ */
#map{width:100%;height:100%}
.map-wrap{position:relative;flex:1}
.leaflet-container{background:#e8f0e8 !important}
.leaflet-popup-content-wrapper{background:var(â€“card) !important;border:1px solid var(â€“border2) !important;border-radius:12px !important;color:var(â€“text) !important;box-shadow:0 8px 32px rgba(0,0,0,.6) !important;padding:0 !important}
.leaflet-popup-content{margin:0 !important}
.leaflet-popup-tip{background:var(â€“card) !important}
.leaflet-popup-close-button{color:var(â€“muted) !important;top:8px !important;right:10px !important}
.popup-wrap{padding:1rem;min-width:220px}
.popup-img{width:100%;height:130px;object-fit:cover;border-radius:8px 8px 0 0;display:block}
.popup-badge{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.4rem}
.popup-title{font-family:â€˜Syneâ€™,sans-serif;font-weight:700;font-size:1rem;margin-bottom:.3rem}
.popup-desc{font-size:.78rem;color:var(â€“text2);line-height:1.5;margin-bottom:.6rem}
.popup-footer{display:flex;justify-content:space-between;font-size:.7rem;color:var(â€“muted)}

/* â”€â”€ OVERLAY / MODAL â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:2000;backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:1rem}
.overlay.open{display:flex}
.modal{background:var(â€“bg2);border:1px solid var(â€“border2);border-radius:18px;width:100%;max-width:500px;max-height:92vh;overflow-y:auto;animation:fadeUp .28s ease;scrollbar-width:thin;scrollbar-color:var(â€“border2) transparent}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.modal-head{padding:1.2rem 1.5rem .9rem;border-bottom:1px solid var(â€“border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(â€“bg2);z-index:1}
.modal-title{font-family:â€˜Syneâ€™,sans-serif;font-weight:700;font-size:1.15rem}
.modal-close{background:none;border:none;color:var(â€“muted);font-size:1.6rem;cursor:pointer;line-height:1;transition:color .2s}
.modal-close:hover{color:var(â€“text)}
.modal-body{padding:1.2rem 1.5rem 1.5rem;display:flex;flex-direction:column;gap:1.1rem}

/* â”€â”€ FORM â”€â”€ */
.flabel{font-size:.72rem;font-weight:600;color:var(â€“muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.35rem;display:block}
.finput,.ftarea{background:var(â€“card);border:1px solid var(â€“border2);border-radius:9px;padding:.7rem .95rem;color:var(â€“text);font-family:â€˜DM Sansâ€™,sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;width:100%}
.finput:focus,.ftarea:focus{border-color:var(â€“accent)}
.ftarea{resize:vertical;min-height:85px}
.type-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.tbtn{padding:.7rem;border:1px solid #2e3f58;border-radius:10px;background:#1a2438;color:var(â€“text2);cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.3rem;font-family:â€˜DM Sansâ€™,sans-serif;font-size:.8rem;box-shadow:0 4px 10px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.06)}
.tbtn .ticon{font-size:1.35rem}
.tbtn:hover{border-color:#4a5e80;background:#233050;color:var(â€“text);box-shadow:0 6px 16px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.1);transform:translateY(-1px)}
.tbtn.sel[data-type=â€œinfraâ€]{border-color:var(â€“infra);color:var(â€“infra);background:rgba(74,158,255,.1)}
.tbtn.sel[data-type=â€œenvâ€]{border-color:var(â€“env);color:var(â€“env);background:rgba(38,216,124,.1)}
.tbtn.sel[data-type=â€œsecâ€]{border-color:var(â€“sec);color:var(â€“sec);background:rgba(244,63,94,.1)}
.tbtn.sel[data-type=â€œotherâ€]{border-color:var(â€“purple);color:var(â€“purple);background:rgba(167,139,250,.1)}

/* â”€â”€ SUBCATS â”€â”€ */
.subcat-wrap{display:none;animation:fadeIn .22s ease}
.subcat-wrap.show{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.subcat-label-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.55rem}
.subcat-back{background:none;border:none;color:var(â€“muted);cursor:pointer;font-size:.78rem;display:flex;align-items:center;gap:.3rem;transition:color .2s;padding:0}
.subcat-back:hover{color:var(â€“text)}
.subcat-grid{display:flex;flex-direction:column;gap:.35rem}
.sbtn{display:flex;align-items:center;gap:.7rem;padding:.65rem .85rem;border-radius:9px;border:1px solid #2e3f58;background:#1a2438;color:var(â€“text2);cursor:pointer;font-family:â€˜DM Sansâ€™,sans-serif;font-size:.82rem;text-align:left;transition:all .18s;width:100%;box-shadow:0 3px 8px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.05)}
.sbtn-icon{font-size:1.1rem;flex-shrink:0;width:22px;text-align:center}
.sbtn-text{flex:1}
.sbtn-text strong{display:block;color:var(â€“text);font-size:.83rem;font-weight:500}
.sbtn-text small{font-size:.72rem;color:var(â€“muted)}
.sbtn:hover{border-color:#4a5e80;background:#233050;box-shadow:0 5px 14px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.09);transform:translateX(2px)}
.sbtn.sel{border-color:var(â€“current-color,var(â€“accent));background:var(â€“current-bg,rgba(255,77,46,.08))}
.sbtn.sel .sbtn-text strong{color:var(â€“current-color,var(â€“accent))}

/* â”€â”€ PHOTO â”€â”€ */
.photo-drop{border:2px dashed var(â€“border2);border-radius:10px;padding:1.2rem;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.photo-drop:hover,.photo-drop.drag{border-color:var(â€“accent);background:rgba(255,77,46,.05)}
.photo-drop input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.photo-drop-icon{font-size:1.8rem;margin-bottom:.3rem}
.photo-drop-text{font-size:.82rem;color:var(â€“muted)}
.photo-drop-text span{color:var(â€“accent)}
.photo-preview{width:100%;height:140px;object-fit:cover;border-radius:9px;border:1px solid var(â€“border2);display:none}
.photo-remove{display:none;background:rgba(244,63,94,.15);border:1px solid rgba(244,63,94,.3);color:var(â€“sec);font-size:.75rem;border-radius:6px;padding:.3rem .7rem;cursor:pointer;margin-top:.4rem}

/* â”€â”€ LOCATION â”€â”€ */
.loc-box{background:var(â€“card);border:1px solid var(â€“border2);border-radius:9px;padding:.7rem .95rem;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
.loc-txt{font-size:.82rem;color:var(â€“muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.loc-txt.set{color:var(â€“green)}
.loc-actions{display:flex;gap:.4rem;flex-shrink:0}
.lbtn{padding:.35rem .7rem;border:1px solid #2e3f58;border-radius:6px;font-size:.72rem;font-weight:600;cursor:pointer;transition:all .2s;box-shadow:0 3px 8px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.07)}
.lbtn-gps{background:#2a3347;color:var(â€“text);border-color:#3a4a65}
.lbtn-gps:hover{background:#344060;border-color:#4a5e80;transform:translateY(-1px);box-shadow:0 5px 12px rgba(0,0,0,.45)}
.lbtn-map{background:#1e2d45;color:var(â€“text2);border-color:#3a4a65}
.lbtn-map:hover{background:#2a3d5c;border-color:#4a5e80;transform:translateY(-1px);box-shadow:0 5px 12px rgba(0,0,0,.45)}

/* â”€â”€ SUBMIT / BUTTONS â”€â”€ */
.btn-submit{background:var(â€“accent);color:white;border:none;padding:.9rem;border-radius:10px;font-family:â€˜Syneâ€™,sans-serif;font-weight:700;font-size:1rem;cursor:pointer;transition:all .2s;width:100%;letter-spacing:.02em;display:flex;align-items:center;justify-content:center;gap:.5rem}
.btn-submit:hover{background:#ff3318;box-shadow:0 4px 24px var(â€“accent-glow);transform:translateY(-1px)}
.btn-submit:disabled{opacity:.6;cursor:not-allowed;transform:none}
.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .7s linear infinite;display:none}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ AUTH MODAL â”€â”€ */
.auth-tabs{display:flex;border-bottom:1px solid var(â€“border);margin-bottom:1rem}
.auth-tab{flex:1;padding:.7rem;background:none;border:none;color:var(â€“muted);font-family:â€˜Syneâ€™,sans-serif;font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.06em;cursor:pointer;transition:all .2s;border-bottom:2px solid transparent;margin-bottom:-1px}
.auth-tab.active{color:var(â€“text);border-bottom-color:var(â€“accent)}
.btn-google{display:flex;align-items:center;justify-content:center;gap:.6rem;background:white;color:#333;border:none;padding:.75rem;border-radius:9px;font-family:â€˜DM Sansâ€™,sans-serif;font-weight:500;font-size:.9rem;cursor:pointer;transition:all .2s;width:100%;margin-bottom:.75rem}
.btn-google:hover{background:#f5f5f5;box-shadow:0 2px 12px rgba(0,0,0,.2)}
.divider{display:flex;align-items:center;gap:.75rem;margin:.75rem 0;font-size:.75rem;color:var(â€“muted)}
.divider::before,.divider::after{content:â€™â€™;flex:1;height:1px;background:var(â€“border)}
.auth-error{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.3);border-radius:8px;padding:.6rem .85rem;font-size:.8rem;color:var(â€“sec);display:none}

/* â”€â”€ MISC â”€â”€ */
.empty{text-align:center;padding:3rem 1rem;color:var(â€“muted)}
.empty-icon{font-size:2.5rem;margin-bottom:.5rem}
.empty p{font-size:.85rem;line-height:1.6}
.toast{position:fixed;bottom:1.5rem;right:1.5rem;padding:.9rem 1.4rem;border-radius:10px;font-weight:700;font-size:.88rem;z-index:3000;transform:translateY(100px);opacity:0;transition:all .3s;display:flex;align-items:center;gap:.5rem}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(â€“green);color:#050e0a}
.toast.error{background:var(â€“red);color:white}
.loading-bar{position:fixed;top:0;left:0;height:2px;background:var(â€“accent);width:0;z-index:9999;transition:width .3s}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(â€“border2);border-radius:3px}
@media(max-width:768px){.app{grid-template-columns:1fr;grid-template-rows:55vh 1fr}.sidebar{order:2}.header-center,.header-right .user-name{display:none}}
</style>

</head>
<body>

<div class="loading-bar" id="loading-bar"></div>

<!-- HEADER -->

<header>
  <div class="logo"><div class="logo-dot"></div>Ciudad<span style="color:var(--accent)">Alerta</span></div>
  <div class="header-center">
    <div class="hstat"><div class="hstat-num or" id="ct-total">â€“</div><div class="hstat-label">Total</div></div>
    <div class="hstat"><div class="hstat-num ye" id="ct-pend">â€“</div><div class="hstat-label">Pendientes</div></div>
    <div class="hstat"><div class="hstat-num gr" id="ct-res">â€“</div><div class="hstat-label">Resueltas</div></div>
  </div>
  <div class="header-right">
    <!-- shown when logged out -->
    <button class="btn-login" id="btn-login-header" onclick="openAuthModal()">Iniciar sesiÃ³n</button>
    <!-- shown when logged in -->
    <div class="user-chip" id="user-chip" style="display:none">
      <div class="user-avatar" id="user-avatar">?</div>
      <span class="user-name" id="user-name-label">â€“</span>
      <button class="btn-signout" onclick="doSignOut()" title="Cerrar sesiÃ³n">âœ•</button>
    </div>
    <button class="btn-new" id="btn-new" onclick="openReportModal()">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 1v12M1 7h12" stroke="white" stroke-width="2.2" stroke-linecap="round"/></svg>
      Nueva denuncia
    </button>
  </div>
</header>

<!-- APP -->

<div class="app">
  <div class="sidebar">
    <div class="filter-row">
      <button class="chip active" data-type="all"   onclick="doFilter('all',this)">Todas</button>
      <button class="chip"        data-type="infra"  onclick="doFilter('infra',this)">ğŸ”§ Infra</button>
      <button class="chip"        data-type="env"    onclick="doFilter('env',this)">ğŸŒ¿ Ambiente</button>
      <button class="chip"        data-type="sec"    onclick="doFilter('sec',this)">ğŸš¨ Seguridad</button>
      <button class="chip"        data-type="other"  onclick="doFilter('other',this)">ğŸ“Œ Otro</button>
    </div>
    <div class="list-header" id="list-lbl">Cargando denunciasâ€¦</div>
    <div class="cards-list" id="cards-list">
      <div class="empty"><div class="empty-icon" style="animation:pulse 1.5s infinite">â³</div><p>Conectando con Firebaseâ€¦</p></div>
    </div>
  </div>
  <div class="map-wrap"><div id="map"></div></div>
</div>

<!-- â”€â”€ REPORT MODAL â”€â”€ -->

<div class="overlay" id="overlay-report">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">ğŸ“‹ Nueva Denuncia</div>
      <button class="modal-close" onclick="closeReportModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div>
        <label class="flabel">CategorÃ­a *</label>
        <div class="type-grid" id="type-grid">
          <button class="tbtn" data-type="infra" onclick="selType('infra',this)"><span class="ticon">ğŸ”§</span><span>Infraestructura</span></button>
          <button class="tbtn" data-type="env"   onclick="selType('env',this)"><span class="ticon">ğŸŒ¿</span><span>Medio Ambiente</span></button>
          <button class="tbtn" data-type="sec"   onclick="selType('sec',this)"><span class="ticon">ğŸš¨</span><span>Seguridad</span></button>
          <button class="tbtn" data-type="other" onclick="selType('other',this)"><span class="ticon">ğŸ“Œ</span><span>Otro</span></button>
        </div>
        <div class="subcat-wrap" id="subcat-wrap">
          <div class="subcat-label-row">
            <button class="subcat-back" onclick="goBackType()">â† Cambiar categorÃ­a</button>
            <span id="subcat-heading" style="font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;margin-left:auto"></span>
          </div>
          <div class="subcat-grid" id="subcat-grid"></div>
        </div>
      </div>
      <div>
        <label class="flabel">TÃ­tulo *</label>
        <input class="finput" id="f-title" type="text" placeholder="Ej: Bache en Av. Principal" maxlength="80">
      </div>
      <div>
        <label class="flabel">DescripciÃ³n</label>
        <textarea class="ftarea" id="f-desc" placeholder="Describe el problema con el mayor detalle posibleâ€¦"></textarea>
      </div>
      <div>
        <label class="flabel">Foto del problema</label>
        <img class="photo-preview" id="photo-prev" alt="vista previa">
        <button class="photo-remove" id="photo-rm" onclick="removePhoto()">âœ• Quitar foto</button>
        <div class="photo-drop" id="photo-drop">
          <input type="file" accept="image/*" id="photo-input" onchange="handlePhoto(event)">
          <div class="photo-drop-icon">ğŸ“·</div>
          <div class="photo-drop-text">Arrastra una imagen o <span>haz clic para subir</span></div>
          <div style="font-size:.7rem;color:var(--muted);margin-top:.2rem">JPG Â· PNG Â· WEBP â€” mÃ¡x 10 MB</div>
        </div>
      </div>
      <div>
        <label class="flabel">UbicaciÃ³n *</label>
        <div class="loc-box">
          <span class="loc-txt" id="loc-txt">Sin ubicaciÃ³n seleccionada</span>
          <div class="loc-actions">
            <button class="lbtn lbtn-gps" onclick="getGPS()">ğŸ“ GPS</button>
            <button class="lbtn lbtn-map" onclick="openMapPicker()">ğŸ—º Elegir en mapa</button>
          </div>
        </div>
      </div>
      <div>
        <label class="flabel">DirecciÃ³n / referencia</label>
        <input class="finput" id="f-addr" type="text" placeholder="Ej: Calle Morelos 78, Col. Centro">
      </div>
      <button class="btn-submit" id="btn-submit" onclick="submitReport()">
        <div class="spinner" id="spinner"></div>
        <span id="submit-label">Enviar Denuncia</span>
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ AUTH MODAL â”€â”€ -->

<div class="overlay" id="overlay-auth">
  <div class="modal" style="max-width:400px">
    <div class="modal-head">
      <div class="modal-title">ğŸ” Acceder</div>
      <button class="modal-close" onclick="closeAuthModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-login"    onclick="switchAuthTab('login')">Iniciar sesiÃ³n</button>
        <button class="auth-tab"        id="tab-register" onclick="switchAuthTab('register')">Registrarse</button>
      </div>
      <button class="btn-google" onclick="loginGoogle()">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.6 33 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.8 2.9l5.7-5.7C34.1 6.5 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 20-8 20-20 0-1.3-.1-2.7-.4-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 16 19 13 24 13c3 0 5.7 1.1 7.8 2.9l5.7-5.7C34.1 6.5 29.3 4 24 4 16.3 4 9.7 8.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5l-6.2-5.2C29.5 35.5 26.9 36.5 24 36.5c-5.2 0-9.6-3.5-11.2-8.3l-6.5 5C9.5 39.4 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.9 2.4-2.5 4.4-4.5 5.8l6.2 5.2C40.8 35.5 44 30.2 44 24c0-1.3-.1-2.7-.4-4z"/></svg>
        Continuar con Google
      </button>
      <div class="divider">o con email</div>
      <div id="auth-error" class="auth-error"></div>
      <div style="display:flex;flex-direction:column;gap:.75rem">
        <div>
          <label class="flabel">Correo electrÃ³nico</label>
          <input class="finput" id="auth-email" type="email" placeholder="correo@ejemplo.com">
        </div>
        <div>
          <label class="flabel">ContraseÃ±a</label>
          <input class="finput" id="auth-pass" type="password" placeholder="MÃ­nimo 6 caracteres">
        </div>
        <button class="btn-submit" id="btn-auth-submit" onclick="submitAuth()">
          <div class="spinner" id="auth-spinner"></div>
          <span id="auth-label">Iniciar sesiÃ³n</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â”€â”€ MAP PICKER OVERLAY â”€â”€ -->

<div id="map-picker-overlay" style="display:none;position:fixed;inset:0;z-index:9999;flex-direction:column;background:#000;">
  <div style="background:#ff4d2e;color:white;padding:1rem 1.2rem;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
    <div>
      <div style="font-family:Syne,sans-serif;font-weight:700;font-size:1rem;">ğŸ“ Mueve el mapa al lugar del problema</div>
      <div id="map-picker-coords" style="font-size:.78rem;opacity:.9;margin-top:.2rem;">Cargando...</div>
    </div>
    <button id="map-picker-btn" onclick="confirmMapPicker()" style="background:white;color:#ff4d2e;border:none;padding:.6rem 1.1rem;border-radius:8px;font-family:Syne,sans-serif;font-weight:700;font-size:.85rem;cursor:pointer;">âœ“ Confirmar</button>
  </div>
  <div style="position:relative;flex:1;">
    <div id="map-picker-map" style="width:100%;height:100%;"></div>
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-100%);z-index:1000;pointer-events:none;font-size:2.5rem;line-height:1;filter:drop-shadow(0 3px 6px rgba(0,0,0,.5));">ğŸ“</div>
  </div>
  <div style="background:#0d1120;padding:.75rem 1.2rem;display:flex;justify-content:flex-end;border-top:1px solid #1c2d48;">
    <button onclick="closeMapPicker()" style="background:none;border:1px solid #243650;color:#94a3bf;padding:.5rem 1rem;border-radius:7px;font-size:.85rem;cursor:pointer;">âœ• Cancelar</button>
  </div>
</div>

<script>
// â”€â”€ CONSTANTS â”€â”€
const TYPE_NAMES  = { infra:'Infraestructura', env:'Medio Ambiente', sec:'Seguridad', other:'Otro' };
const TYPE_COLORS = { infra:'#4a9eff', env:'#26d87c', sec:'#f43f5e', other:'#a78bfa' };
const TYPE_ICONS  = { infra:'ğŸ”§', env:'ğŸŒ¿', sec:'ğŸš¨', other:'ğŸ“Œ' };
const STA_LABEL   = { pending:'Pendiente', review:'En revisiÃ³n', resolved:'Resuelto' };
const STA_CLS     = { pending:'s-pending', review:'s-review', resolved:'s-resolved' };

const SUBCATS = {
  sec:[
    {id:'asalto-violencia',   icon:'ğŸ”ª',label:'Asalto con violencia',       hint:'Robo con amenazas, armas o agresiÃ³n fÃ­sica'},
    {id:'asalto-sin-violencia',icon:'ğŸ‘œ',label:'Asalto sin violencia',       hint:'Robo sin contacto fÃ­sico ni amenaza directa'},
    {id:'robo-autopartes',    icon:'ğŸš—',label:'Robo de autopartes',          hint:'Espejos, rines, catalizadores, accesorios'},
    {id:'robo-vehiculo',      icon:'ğŸ”‘',label:'Robo de vehÃ­culo',            hint:'AutomÃ³vil, moto, bicicleta'},
    {id:'robo-casa',          icon:'ğŸ ',label:'Robo a casa habitaciÃ³n',      hint:'Entrada forzada, allanamiento'},
    {id:'robo-negocio',       icon:'ğŸª',label:'Robo a negocio',              hint:'Local comercial, tienda, oficina'},
    {id:'vandalismo',         icon:'ğŸ–Šï¸',label:'Vandalismo / grafiti',        hint:'DaÃ±os a propiedad pÃºblica o privada'},
    {id:'acoso',              icon:'âš ï¸',label:'Acoso o intimidaciÃ³n',        hint:'Hostigamiento, amenazas, seguimiento'},
    {id:'pelea',              icon:'ğŸ¥Š',label:'RiÃ±a o pelea callejera',      hint:'Altercado fÃ­sico en vÃ­a pÃºblica'},
    {id:'disparo',            icon:'ğŸ’¥',label:'Detonaciones / disparos',     hint:'Sonidos de arma de fuego en la zona'},
    {id:'fraude',             icon:'ğŸ’³',label:'Fraude o estafa',             hint:'ClonaciÃ³n, timo, engaÃ±o econÃ³mico'},
    {id:'otro-sec',           icon:'ğŸš”',label:'Otro delito',                 hint:'Incidente no listado arriba'},
  ],
  infra:[
    {id:'bache',        icon:'ğŸ•³ï¸',label:'Bache / hundimiento',              hint:'DaÃ±o en pavimento o asfalto'},
    {id:'semaforo',     icon:'ğŸš¦',label:'SemÃ¡foro daÃ±ado o apagado',        hint:'Sin funcionar o mal sincronizado'},
    {id:'alumbrado',    icon:'ğŸ’¡',label:'Falla de alumbrado pÃºblico',       hint:'Postes apagados o parpadeantes'},
    {id:'banqueta',     icon:'ğŸš¶',label:'Banqueta rota o bloqueada',        hint:'Acera en mal estado o con obstÃ¡culos'},
    {id:'fuga-agua',    icon:'ğŸ’§',label:'Fuga de agua potable',             hint:'TuberÃ­a rota, desperdicio de agua'},
    {id:'drenaje',      icon:'ğŸŒŠ',label:'Drenaje tapado / inundaciÃ³n',      hint:'Coladera bloqueada, encharcamiento'},
    {id:'cables',       icon:'âš¡',label:'Cables caÃ­dos o peligrosos',      hint:'Riesgo elÃ©ctrico en vÃ­a pÃºblica'},
    {id:'puente',       icon:'ğŸŒ‰',label:'DaÃ±o en puente o paso a desnivel', hint:'Estructura con grietas o peligrosa'},
    {id:'seÃ±alamiento', icon:'ğŸ›‘',label:'SeÃ±alamiento vial daÃ±ado',         hint:'SeÃ±ales caÃ­das, ilegibles o faltantes'},
    {id:'otro-infra',   icon:'ğŸ”§',label:'Otro problema de infraestructura', hint:'No listado arriba'},
  ],
  env:[
    {id:'basura-calle',       icon:'ğŸ—‘ï¸',label:'Basura en vÃ­a pÃºblica',      hint:'AcumulaciÃ³n en calles o banquetas'},
    {id:'tiradero',           icon:'ğŸ”ï¸',label:'Tiradero clandestino',        hint:'Desecho ilegal de escombros o basura'},
    {id:'quema',              icon:'ğŸ”¥',label:'Quema de basura / residuos', hint:'Incendio intencional de desechos'},
    {id:'fuga-residual',      icon:'â˜£ï¸',label:'Fuga de aguas residuales',   hint:'Derrames de drenaje o aguas negras'},
    {id:'contaminacion-agua', icon:'ğŸŒŠ',label:'ContaminaciÃ³n de agua',      hint:'RÃ­o, lago, canal contaminado'},
    {id:'ruido',              icon:'ğŸ”Š',label:'ContaminaciÃ³n por ruido',    hint:'Ruido excesivo, mÃºsica, industria'},
    {id:'fauna',              icon:'ğŸ€',label:'Fauna nociva / plaga',       hint:'Ratas, cucarachas, perros agresivos'},
    {id:'arbol',              icon:'ğŸŒ³',label:'Ãrbol caÃ­do o peligroso',    hint:'Riesgo de caÃ­da sobre personas o vehÃ­culos'},
    {id:'otro-env',           icon:'ğŸŒ¿',label:'Otro problema ambiental',    hint:'No listado arriba'},
  ],
  other:[
    {id:'obra-ilegal',        icon:'ğŸ—ï¸',label:'Obra o construcciÃ³n ilegal',    hint:'Sin permiso o que invade espacio pÃºblico'},
    {id:'vendedor-ambulante', icon:'ğŸ›’',label:'Vendedor ambulante conflictivo', hint:'Que obstaculiza o genera problemas'},
    {id:'estacionamiento',    icon:'ğŸ…¿ï¸',label:'VehÃ­culo mal estacionado',      hint:'Bloquea salidas, rampas o accesos'},
    {id:'publicidad',         icon:'ğŸ“¢',label:'Publicidad ilegal / propaganda', hint:'Anuncios sin permiso en vÃ­a pÃºblica'},
    {id:'mascota',            icon:'ğŸ•',label:'Animal abandonado o maltratado', hint:'Mascota en situaciÃ³n de riesgo'},
    {id:'otro-otro',          icon:'ğŸ“Œ',label:'Otro',                           hint:'SituaciÃ³n no clasificada'},
  ],
};

// â”€â”€ STATE â”€â”€
let reports = [];
let map;
let curFilter='all';
let fType=null, fSubcat=null, fLat=null, fLng=null, fPhoto=null;
let mkrs={};
let currentUser=null;
let authMode='login';
let fbReady=false;

// â”€â”€ INIT MAP + FIREBASE on DOM ready â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  // Map - using light street tiles for better visibility
  map = L.map('map').setView([19.432,-99.136],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {attribution:'Â© OpenStreetMap contributors',maxZoom:19}).addTo(map);
  setLoading(true);

  // Auth listener
  window._auth.onAuthStateChanged(user => {
    currentUser = user;
    updateAuthUI(user);
  });

  // Firestore real-time listener
  window._db.collection('denuncias').onSnapshot(snap => {
    reports = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
    fbReady = true;
    renderAll();
    setLoading(false);
  }, err => {
    console.error('Firestore error:', err);
    showToast('Error Firestore: ' + err.message, 'error');
    setLoading(false);
    document.getElementById('list-lbl').textContent = 'Error de conexiÃ³n';
  });
});

// â”€â”€ MAP â”€â”€
function mkIcon(type) {
  const c=TYPE_COLORS[type], i=TYPE_ICONS[type];
  return L.divIcon({className:'',
    html:`<div style="width:34px;height:34px;background:${c};border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:2.5px solid rgba(255,255,255,.75);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(0,0,0,.55)"><span style="transform:rotate(45deg);font-size:14px">${i}</span></div>`,
    iconSize:[34,34],iconAnchor:[17,34],popupAnchor:[0,-38]});
}

function addMarker(r) {
  if(!r.lat || !r.lng || isNaN(r.lat) || isNaN(r.lng)) return;
  const m = L.marker([r.lat,r.lng],{icon:mkIcon(r.type)}).addTo(map);
  const c = TYPE_COLORS[r.type];
  const ph = r.photoUrl ? `<img src="${r.photoUrl}" class="popup-img">` : '';
  const subcatLine = r.subcatLabel ? `<div style="font-size:.72rem;color:${c};margin-bottom:.35rem;font-weight:600">${r.subcatIcon||''} ${r.subcatLabel}</div>` : '';
  const uid = r.firestoreId||r.id;
  m.bindPopup(`<div>${ph}<div class="popup-wrap"><div class="popup-badge" style="color:${c}">${TYPE_NAMES[r.type]}</div>${subcatLine}<div class="popup-title">${r.title}</div><div class="popup-desc">${r.desc}</div><div class="popup-footer"><span>ğŸ“ ${r.address}</span><span>ğŸ‘ ${r.votes||0}</span><span>${r.date}</span></div></div></div>`);
  m.on('click',()=>hlCard(uid));
  mkrs[uid]=m;
}

function renderAll() {
  renderCards(); renderMkrs(); updateStats();
}

function renderCards() {
  const el = document.getElementById('cards-list');
  const list = curFilter==='all' ? reports : reports.filter(r=>r.type===curFilter);
  document.getElementById('list-lbl').textContent =
    `${list.length} denuncia${list.length!==1?'s':''} ${curFilter!=='all'?'â€” '+TYPE_NAMES[curFilter]:'en tiempo real'}`;
  if(!list.length){
    el.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ”</div><p>No hay denuncias en esta categorÃ­a todavÃ­a.<br>Â¡SÃ© el primero en reportar!</p></div>`;
    return;
  }
  el.innerHTML=list.map(r=>{
    const uid=r.firestoreId||r.id;
    return `<div class="rcard" id="card-${uid}" data-type="${r.type}" onclick="focusRep('${uid}')">
      <div class="rcard-top"><span class="rcard-badge">${r.subcatIcon||TYPE_ICONS[r.type]} ${r.subcatLabel||TYPE_NAMES[r.type]}</span><span class="rcard-status ${STA_CLS[r.status]||'s-pending'}">${STA_LABEL[r.status]||'Pendiente'}</span></div>
      ${r.photoUrl?`<img class="rcard-photo" src="${r.photoUrl}" alt="">`:''}
      <div class="rcard-title">${r.title}</div>
      <div class="rcard-desc">${r.desc}</div>
      <div class="rcard-meta"><span class="rcard-loc">ğŸ“ ${r.address}</span><span>ğŸ“… ${r.date}</span></div>
    </div>`;
  }).join('');
}

function renderMkrs() {
  Object.values(mkrs).forEach(m=>map&&map.removeLayer(m)); mkrs={};
  (curFilter==='all'?reports:reports.filter(r=>r.type===curFilter)).forEach(addMarker);
}

function updateStats() {
  document.getElementById('ct-total').textContent=reports.length;
  document.getElementById('ct-pend').textContent=reports.filter(r=>r.status==='pending'||!r.status).length;
  document.getElementById('ct-res').textContent=reports.filter(r=>r.status==='resolved').length;
}

function hlCard(uid) {
  document.querySelectorAll('.rcard').forEach(c=>c.classList.remove('active'));
  const c=document.getElementById('card-'+uid);
  if(c){c.classList.add('active');c.scrollIntoView({behavior:'smooth',block:'nearest'});}
}

function focusRep(uid) {
  const r=reports.find(x=>(x.firestoreId||x.id)==uid); if(!r) return;
  map.flyTo([r.lat,r.lng],16,{duration:.7});
  setTimeout(()=>mkrs[uid]?.openPopup(),750);
  hlCard(uid);
}

function doFilter(type,btn) {
  curFilter=type;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  renderAll();
}

// â”€â”€ AUTH UI â”€â”€
function updateAuthUI(user) {
  currentUser = user;
  const chip=document.getElementById('user-chip');
  const btnLogin=document.getElementById('btn-login-header');
  const btnNew=document.getElementById('btn-new');
  if(user){
    chip.style.display='flex';
    btnLogin.style.display='none';
    document.getElementById('user-avatar').textContent=(user.displayName||user.email||'U')[0].toUpperCase();
    document.getElementById('user-name-label').textContent=user.displayName||user.email;
    btnNew.disabled=false;
    btnNew.title='';
  } else {
    chip.style.display='none';
    btnLogin.style.display='block';
    btnNew.disabled=false; // allow anonymous? set true to require login
    btnNew.title='';
  }
}

// â”€â”€ AUTH MODAL â”€â”€
function openAuthModal() { document.getElementById('overlay-auth').classList.add('open'); }
function closeAuthModal() { document.getElementById('overlay-auth').classList.remove('open'); document.getElementById('auth-error').style.display='none'; }

function switchAuthTab(tab) {
  authMode=tab;
  document.getElementById('tab-login').classList.toggle('active',tab==='login');
  document.getElementById('tab-register').classList.toggle('active',tab==='register');
  document.getElementById('auth-label').textContent=tab==='login'?'Iniciar sesiÃ³n':'Crear cuenta';
  document.getElementById('auth-error').style.display='none';
}

function loginGoogle() {
  window._auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
    .then(()=>{ closeAuthModal(); showToast('Â¡Bienvenido/a! ğŸ‘‹','success'); })
    .catch(e=>showAuthError(e.message));
}

function submitAuth() {
  const email=document.getElementById('auth-email').value.trim();
  const pass=document.getElementById('auth-pass').value;
  if(!email||!pass){showAuthError('Completa todos los campos.');return;}
  const sp=document.getElementById('auth-spinner');
  const lb=document.getElementById('auth-label');
  sp.style.display='block'; lb.textContent='';
  const fn=authMode==='login'?window._auth.signInWithEmailAndPassword.bind(window._auth):window._auth.createUserWithEmailAndPassword.bind(window._auth);
  fn(email,pass)
    .then(()=>{ closeAuthModal(); showToast(authMode==='login'?'Â¡Bienvenido/a! ğŸ‘‹':'Â¡Cuenta creada! ğŸ‰','success'); })
    .catch(e=>{ showAuthError(friendlyAuthError(e.code)); })
    .finally(()=>{ sp.style.display='none'; lb.textContent=authMode==='login'?'Iniciar sesiÃ³n':'Crear cuenta'; });
}

function doSignOut() {
  window._auth.signOut().then(()=>showToast('SesiÃ³n cerrada','success'));
}

function showAuthError(msg) {
  const el=document.getElementById('auth-error');
  el.textContent=msg; el.style.display='block';
}

function friendlyAuthError(code) {
  const map={'auth/user-not-found':'Correo no registrado.','auth/wrong-password':'ContraseÃ±a incorrecta.','auth/email-already-in-use':'Este correo ya estÃ¡ registrado.','auth/weak-password':'La contraseÃ±a debe tener al menos 6 caracteres.','auth/invalid-email':'Correo invÃ¡lido.'};
  return map[code]||'Error de autenticaciÃ³n. Intenta de nuevo.';
}

// â”€â”€ REPORT MODAL â”€â”€
function openReportModal() {
  document.getElementById('overlay-report').classList.add('open');
  fType=null; fSubcat=null; fLat=null; fLng=null; fPhoto=null;
  ['f-title','f-desc','f-addr'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('photo-input').value='';
  document.getElementById('photo-prev').style.display='none';
  document.getElementById('photo-rm').style.display='none';
  document.getElementById('photo-drop').style.display='block';
  document.getElementById('loc-txt').textContent='Sin ubicaciÃ³n seleccionada';
  document.getElementById('loc-txt').classList.remove('set');
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('sel'));
  document.getElementById('type-grid').style.display='grid';
  document.getElementById('subcat-wrap').classList.remove('show');
  document.getElementById('f-title').placeholder='Ej: Bache en Av. Principal';
  document.getElementById('submit-label').textContent='Enviar Denuncia';
  document.getElementById('spinner').style.display='none';
}
function closeReportModal() { document.getElementById('overlay-report').classList.remove('open'); }

// â”€â”€ TYPE + SUBCAT â”€â”€
function selType(type,btn) {
  fType=type; fSubcat=null;
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  showSubcats(type);
}

function showSubcats(type) {
  const c=TYPE_COLORS[type];
  const bg=type==='infra'?'rgba(74,158,255,.08)':type==='env'?'rgba(38,216,124,.08)':type==='sec'?'rgba(244,63,94,.08)':'rgba(167,139,250,.08)';
  document.getElementById('subcat-heading').textContent=TYPE_ICONS[type]+' '+TYPE_NAMES[type];
  document.getElementById('subcat-heading').style.color=c;
  document.getElementById('subcat-grid').innerHTML=(SUBCATS[type]||[]).map(s=>`
    <button class="sbtn" style="--current-color:${c};--current-bg:${bg}" onclick="selSubcat('${s.id}',this,'${type}')">
      <span class="sbtn-icon">${s.icon}</span>
      <span class="sbtn-text"><strong>${s.label}</strong><small>${s.hint}</small></span>
    </button>`).join('');
  document.getElementById('type-grid').style.display='none';
  document.getElementById('subcat-wrap').classList.add('show');
}

function selSubcat(id,btn,type) {
  fSubcat=id;
  document.querySelectorAll('.sbtn').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  const sub=(SUBCATS[type]||[]).find(s=>s.id===id);
  if(sub && !document.getElementById('f-title').value.trim())
    document.getElementById('f-title').value=sub.label;
}

function goBackType() {
  fType=null; fSubcat=null;
  document.getElementById('type-grid').style.display='grid';
  document.getElementById('subcat-wrap').classList.remove('show');
  document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('sel'));
  document.getElementById('f-title').value='';
  document.getElementById('f-title').placeholder='Ej: Bache en Av. Principal';
}

// â”€â”€ PHOTO â”€â”€
function handlePhoto(e) {
  const f=e.target.files[0]; if(!f) return;
  if(f.size>10*1024*1024){showToast('Imagen muy grande (mÃ¡x 10 MB)','error');return;}
  const rd=new FileReader();
  rd.onload=ev=>{
    fPhoto=ev.target.result;
    const p=document.getElementById('photo-prev');
    p.src=fPhoto; p.style.display='block';
    document.getElementById('photo-rm').style.display='inline-block';
    document.getElementById('photo-drop').style.display='none';
  };
  rd.readAsDataURL(f);
}
function removePhoto() {
  fPhoto=null;
  document.getElementById('photo-prev').style.display='none';
  document.getElementById('photo-rm').style.display='none';
  document.getElementById('photo-drop').style.display='block';
  document.getElementById('photo-input').value='';
}
const dropEl=document.getElementById('photo-drop');
dropEl.addEventListener('dragover',e=>{e.preventDefault();dropEl.classList.add('drag');});
dropEl.addEventListener('dragleave',()=>dropEl.classList.remove('drag'));
dropEl.addEventListener('drop',e=>{
  e.preventDefault(); dropEl.classList.remove('drag');
  const f=e.dataTransfer.files[0];
  if(f&&f.type.startsWith('image/')){
    const rd=new FileReader();
    rd.onload=ev=>{
      fPhoto=ev.target.result;
      document.getElementById('photo-prev').src=fPhoto;
      document.getElementById('photo-prev').style.display='block';
      document.getElementById('photo-rm').style.display='inline-block';
      dropEl.style.display='none';
    };
    rd.readAsDataURL(f);
  }
});

// â”€â”€ LOCATION â”€â”€
function setLoc(lat,lng) {
  fLat=lat; fLng=lng;
  document.getElementById('loc-txt').textContent=`ğŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  document.getElementById('loc-txt').classList.add('set');
}
function getGPS() {
  if(!navigator.geolocation){showToast('Tu navegador no soporta GPS','error');return;}
  document.getElementById('loc-txt').textContent='Obteniendo GPSâ€¦';
  navigator.geolocation.getCurrentPosition(
    p=>{ setLoc(p.coords.latitude,p.coords.longitude); showToast('UbicaciÃ³n GPS obtenida âœ“','success'); },
    ()=>{ const c=map.getCenter(); setLoc(c.lat,c.lng); showToast('Usando centro del mapa','success'); }
  );
}

// â”€â”€ MAP PICKER â”€â”€
let pickerMap=null, pickerMarker=null, pickerLat=null, pickerLng=null;

function openMapPicker() {
  document.getElementById('overlay-report').style.display='none';
  document.getElementById('map-picker-overlay').style.display='flex';
  document.getElementById('map-picker-btn').disabled=true;
  document.getElementById('map-picker-coords').textContent='Mueve el mapa para seleccionar';

  const startLat = fLat||map.getCenter().lat;
  const startLng = fLng||map.getCenter().lng;

  if(!pickerMap) {
    pickerMap = L.map('map-picker-map').setView([startLat, startLng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {attribution:'Â© OpenStreetMap',maxZoom:19}).addTo(pickerMap);

    // Update coords as map moves
    pickerMap.on('move', () => {
      const c = pickerMap.getCenter();
      pickerLat = c.lat; pickerLng = c.lng;
      document.getElementById('map-picker-coords').textContent=`ğŸ“ ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
      document.getElementById('map-picker-btn').disabled=false;
    });
    // Enable immediately with current center
    setTimeout(()=>{
      const c=pickerMap.getCenter();
      pickerLat=c.lat; pickerLng=c.lng;
      document.getElementById('map-picker-coords').textContent=`ğŸ“ ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
      document.getElementById('map-picker-btn').disabled=false;
    }, 300);
  } else {
    pickerMap.setView([startLat, startLng], 16);
    setTimeout(()=>pickerMap.invalidateSize(),100);
  }
  setTimeout(()=>pickerMap.invalidateSize(),200);
}

function confirmMapPicker() {
  if(!pickerLat) { pickerLat=pickerMap.getCenter().lat; pickerLng=pickerMap.getCenter().lng; }
  setLoc(pickerLat, pickerLng);
  closeMapPicker();
  showToast('UbicaciÃ³n seleccionada âœ“','success');
}

function closeMapPicker() {
  document.getElementById('map-picker-overlay').style.display='none';
  document.getElementById('overlay-report').style.display='';
}

// â”€â”€ SUBMIT TO FIREBASE â”€â”€
// â”€â”€ COMPRESS IMAGE (canvas resize â€” no Storage needed) â”€â”€
function compressImage(dataUrl, maxPx, quality) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      let w=img.width, h=img.height;
      if(w>maxPx||h>maxPx){ const r=Math.min(maxPx/w,maxPx/h); w=Math.round(w*r); h=Math.round(h*r); }
      const canvas=document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.src=dataUrl;
  });
}

async function submitReport() {
  if(!window._fbReady){showToast('Conectando, espera un momentoâ€¦','error');return;}
  const title=document.getElementById('f-title').value.trim();
  if(!fType){showToast('Selecciona una categorÃ­a','error');return;}
  if(!fSubcat){showToast('Elige el tipo especÃ­fico de incidente','error');return;}
  if(!title){showToast('Escribe un tÃ­tulo','error');return;}
  if(!fLat){showToast('Selecciona una ubicaciÃ³n','error');return;}

  const sub=(SUBCATS[fType]||[]).find(s=>s.id===fSubcat);
  const btn=document.getElementById('btn-submit');
  const sp=document.getElementById('spinner');
  const lbl=document.getElementById('submit-label');
  btn.disabled=true; sp.style.display='block'; lbl.textContent='Guardandoâ€¦';

  try {
    // 1. Compress photo to max 800px / 60% quality before storing in Firestore
    let photoUrl = null;
    if(fPhoto) {
      photoUrl = await compressImage(fPhoto, 800, 0.6);
    }

    // 2. Save to Firestore (photo stored as compressed base64 string)
    const docData = {
      type: fType,
      subcat: fSubcat,
      subcatLabel: sub?.label||'',
      subcatIcon: sub?.icon||'',
      title,
      desc: document.getElementById('f-desc').value.trim()||'Sin descripciÃ³n adicional.',
      address: document.getElementById('f-addr').value.trim()||`${fLat.toFixed(4)}, ${fLng.toFixed(4)}`,
      lat: fLat,
      lng: fLng,
      status: 'pending',
      date: new Date().toISOString().slice(0,10),
      votes: 0,
      photoUrl,
      userId: window._currentUser?.uid||'anonymous',
      userEmail: window._currentUser?.email||'anÃ³nimo',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await window._db.collection('denuncias').add(docData);

    closeReportModal();
    map.flyTo([fLat,fLng],16,{duration:.8});
    showToast('âœ… Denuncia guardada en Firebase','success');

  } catch(err) {
    console.error(err);
    showToast('Error al guardar: '+err.message,'error');
  } finally {
    btn.disabled=false; sp.style.display='none'; lbl.textContent='Enviar Denuncia';
  }
}

// â”€â”€ HELPERS â”€â”€
function showToast(msg, type='success') {
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast '+type;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3500);
}

function setLoading(on) {
  const lb=document.getElementById('loading-bar');
  lb.style.width=on?'70%':'100%';
  if(!on) setTimeout(()=>lb.style.width='0',400);
}

// â”€â”€ CLOSE ON BACKDROP â”€â”€
document.getElementById('overlay-report').addEventListener('click',e=>{if(e.target===document.getElementById('overlay-report'))closeReportModal();});
document.getElementById('overlay-auth').addEventListener('click',e=>{if(e.target===document.getElementById('overlay-auth'))closeAuthModal();});
document.addEventListener('keydown',e=>{ if(e.key==='Escape'){closeReportModal();closeAuthModal();} });
</script>

</body>
</html>
